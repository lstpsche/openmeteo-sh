#!/usr/bin/env bash
# openmeteo -- CLI tool for the OpenMeteo API suite
set -euo pipefail

# Resolve symlinks so Homebrew/apt symlinked installs find lib/ and commands/
_resolve_script_dir() {
  local src="${BASH_SOURCE[0]}"
  while [[ -L "$src" ]]; do
    local dir
    dir="$(cd "$(dirname "$src")" && pwd)"
    src="$(readlink "$src")"
    [[ "$src" != /* ]] && src="$dir/$src"
  done
  cd "$(dirname "$src")" && pwd
}
SCRIPT_DIR="$(_resolve_script_dir)"

# Load libraries
source "${SCRIPT_DIR}/lib/core.sh"
source "${SCRIPT_DIR}/lib/output.sh"
source "${SCRIPT_DIR}/lib/geo.sh"

# Load config and apply global defaults (format, verbose)
_load_config
_apply_config_globals

# ---------------------------------------------------------------------------
# Help
# ---------------------------------------------------------------------------

_print_version() {
  echo "openmeteo ${OPENMETEO_VERSION}"
}

_print_help() {
  cat <<EOF
openmeteo ${OPENMETEO_VERSION} -- CLI tool for the OpenMeteo API

Usage:
  openmeteo <command> [options]

Commands:
  weather      Weather forecast (up to 16 days)
  geo          Geocoding (search locations by name)
  history      Historical weather data (from 1940)
  ensemble     Ensemble model forecasts
  climate      Climate change projections (1950-2050)
  marine       Marine / wave forecasts
  air-quality  Air quality & pollen forecasts
  flood        River discharge / flood forecasts
  elevation    Terrain elevation lookup
  satellite    Satellite solar radiation data
  config       Manage configuration file

Output modes:
  (default)       Human-friendly: colored, with emojis, grouped by day
  --porcelain     Machine-parseable: flat key=value lines for scripts/agents
  --llm           Compact TSV tables, minimal tokens, for AI agents
  --raw           Raw JSON from the API (for piping to jq, etc.)

Global options:
  --api-key=KEY   OpenMeteo API key (overrides OPENMETEO_API_KEY env var)
  --verbose       Show resolved locations and full request URLs
  --help          Show help for a command
  --version       Show version

Environment variables:
  OPENMETEO_API_KEY   Default API key for commercial access
  OPENMETEO_CONFIG    Override config file path (default: ~/.config/openmeteo/config)

Arguments accept both --key=value and --key value syntax.

Examples:
  openmeteo weather --current --city=London
  openmeteo weather --current --city London
  openmeteo geo --search=Berlin
  openmeteo weather --forecast-days=3 --lat=52.52 --lon=13.41
  openmeteo weather --current --city Tokyo --porcelain
  openmeteo elevation --lat=47.37 --lon=8.55

Run 'openmeteo <command> help' for command-specific help.
Run 'openmeteo <command> help --daily-params' for available variables.
EOF
}

# ---------------------------------------------------------------------------
# Dispatch
# ---------------------------------------------------------------------------

if [[ $# -eq 0 ]]; then
  _print_help
  exit 0
fi

command="$1"
shift

case "${command}" in
  weather)
    source "${SCRIPT_DIR}/commands/weather.sh"
    cmd_weather "$@"
    ;;
  geo)
    source "${SCRIPT_DIR}/commands/geo.sh"
    cmd_geo "$@"
    ;;
  history)
    source "${SCRIPT_DIR}/commands/history.sh"
    cmd_history "$@"
    ;;
  ensemble)
    source "${SCRIPT_DIR}/commands/ensemble.sh"
    cmd_ensemble "$@"
    ;;
  climate)
    source "${SCRIPT_DIR}/commands/climate.sh"
    cmd_climate "$@"
    ;;
  marine)
    source "${SCRIPT_DIR}/commands/marine.sh"
    cmd_marine "$@"
    ;;
  air-quality)
    source "${SCRIPT_DIR}/commands/air_quality.sh"
    cmd_air_quality "$@"
    ;;
  flood)
    source "${SCRIPT_DIR}/commands/flood.sh"
    cmd_flood "$@"
    ;;
  elevation)
    source "${SCRIPT_DIR}/commands/elevation.sh"
    cmd_elevation "$@"
    ;;
  satellite)
    source "${SCRIPT_DIR}/commands/satellite.sh"
    cmd_satellite "$@"
    ;;
  config)
    source "${SCRIPT_DIR}/commands/config.sh"
    cmd_config "$@"
    ;;
  --help|-h|help)
    _print_help
    exit 0
    ;;
  --version|-v|version)
    _print_version
    exit 0
    ;;
  *)
    _die "unknown command: '${command}'. Run 'openmeteo --help' for usage."
    ;;
esac
